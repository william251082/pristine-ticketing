kubectl delete -A ValidatingWebhookConfiguration ingress-nginx-admission

Accessing Env Variables in a Pod
imperative approach, instead of writing a config file(declarative)
kubectl create secret generic jwt-secret --from-literal=JWT_KEY=asdf
kubectl get secrets
kubectl describe pods <name_of_pod>

File detection change
kubectl get pods
kubectl delete pod client-depl-85b6fb44f9-2wrph
kubectl get pods


I found out that minikube has it own docker instance

Run eval $(minikube docker-env)

Then in same terminal window run docker system df

This command will print out something like this

TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE
Images              5                   2                   16.43 MB            11.63 MB (70%)
Containers          2                   0                   212 B               212 B (100%)
Local Volumes       2                   1                   36 B                0 B (0%)
Based on this information you need to clear up resources

iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/nats-test$ npm install node-nats-streaming ts-node-dev typescript @types/node


kubectl get pods
kubectl port-forward nats-depl-78677c4455-8nqqb 4222:4222
on another terminal window:
npm run publish

npm run publish
npm run listen
rs to restart

Queue groups
-- making sure the published event is not duplicated among every service listeners


default --when service received an event, it will automatically marked as event received, leading to error data (if any), being lost
overwrite default behavior using .setManualAckMode(true);

iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing$ kubectl port-forward nats-depl-78677c4455-8nqqb 8222:8222
on browser: localhost:8222/streaming
localhost:8222/streaming/channelsz?subs=1
-- help nats to understand to know a client subscription that won't ever come back
-hb -- request that nats is going to send to all connected clients every second
-hbi -- how often nats will send requests to the connected clients
-hbt -- how long each client has to respond
-hbt -- number of times the request should fail before nats will assume that the connection is gone

setDeliverAllAvailable()
restart npm run publish
npm run listen
list of all events will be listed down

iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/common$ npm install node-nats-streaming
iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/common$ npm run pub
iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/tickets$ npm update @iceshoptickets/common

iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing$ kubectl delete pod nats-depl-78677c4455-8nqqb


iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing$ kubectl delete pod nats-depl-85f7b46dfb-hr2d6
pod "nats-depl-85f7b46dfb-hr2d6" deleted
iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing$ kubectl get pods
NAME                                  READY   STATUS    RESTARTS   AGE
auth-depl-7b69cc7d47-8msxf            1/1     Running   0          7m26s
auth-mongo-depl-fc4596ff8-k4lzs       1/1     Running   0          7m26s
client-depl-54fffbfc8b-spdwv          1/1     Running   0          7m26s
nats-depl-85f7b46dfb-qtgcs            1/1     Running   0          17s
tickets-depl-7f8746c7b-slznr          1/1     Running   1          2m
tickets-mongo-depl-68cbb6cd78-5xr9n   1/1     Running   0          7m26s
iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing$

iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/nats-test$ kubectl port-forward nats-depl-85f7b46dfb-qtgcs 4222:4222
iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/nats-test$ npm run listen
on post man post a new ticket https://ticketing.dev/api/tickets

Handling Publish Failures
-- saving the record and event at the same time
-- separate code/process watching Events
--pull events from events collection the publish to nats
-- wrap up saving the event inside the database transaction

kubectl get pods


iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/orders$ npm install
iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/orders$ docker build -t iceshop/orders .
iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/orders$ docker push iceshop/orders

A Quick Manual Test

POST https://ticketing.dev/api/tickets
{
    "title": "concert",
    "price": 80
}

PUT https://ticketing.dev/api/tickets/5f23c9371110780023f2475f
{
    "title": "concert",
    "price": 81
}

creating ticket
[tickets-depl-dd4847768-9b4br tickets] Event published to subject ticket:created
[orders-depl-784bd94794-mf2sm orders] Message received: ticket:created / orders-service

updating ticket
[tickets-depl-dd4847768-9b4br tickets] Event published to subject ticket:updated
[orders-depl-784bd94794-mf2sm orders] Message received: ticket:updated / orders-service


MONGO SHELL TO THE ORDERS DB
db.tickets.remove({})
db.tickets.find({price:10}).length()

MONGO SHELL TO THE TICKETS DB
db.tickets.remove({})
db.tickets.find({price:10}).length()

iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/tickets$ npm install mongoose-update-if-current
iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/orders$ npm install mongoose-update-if-current


with version attribute
creating ticket
[tickets-depl-dd4847768-9b4br tickets] Event published to subject ticket:created
[orders-depl-784bd94794-mf2sm orders] Message received: ticket:created / orders-service

updating ticket
[tickets-depl-dd4847768-9b4br tickets] Event published to subject ticket:updated
[orders-depl-784bd94794-mf2sm orders] Message received: ticket:updated / orders-service


executing mongo db in a pod
kubectl get pods
iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/tickets$ kubectl exec -it tickets-mongo-depl-57dfb6bb6b-7zbpb mongo
iceshop@iceshop-X580VD:~/Sites/microservicests/ticketing/orders$ kubectl exec -it orders-mongo-depl-57dfb6bb6b-7zbpb mongo

> show dbs;
admin   0.000GB
config  0.000GB
local   0.000GB
orders  0.000GB
> use orders;
switched to db orders
> db.tickets
orders.tickets
> db.tickets.find({ price: 80 })
> db.tickets.find({ price: 8000 })
> db.tickets.find({ price: 800 })

whenever there's order:cancelled or order:create, event should be emitted
so all services can update their own versions


npm install bull @types/bull
docker build -t iceshop/expiration .
docker push iceshop/expiration

Manually restart pod:
kubectl delete pod <pod_name>

Testing Job Processing
on postman
GET https://ticketing.dev/api/users/currentuser
POST https://ticketing.dev/api/tickets
{
    "title": "concert",
    "price": 908
}
POST https://ticketing.dev/api/orders
{
    "ticketId": "5f267de95757af0018ddf45b"
}

[tickets-depl-7b8c654ffb-fmvt6 tickets] Event published to subject ticket:created
[orders-depl-5755694bf7-9v7sx orders] Message received: ticket:created / orders-service
[orders-depl-5755694bf7-9v7sx orders] Event published to subject order:created
[tickets-depl-7b8c654ffb-fmvt6 tickets] Message received: order:created / tickets-service
[expiration-depl-56b4bd57b9-2nthb expiration] Message received: order:created / expiration-service
[expiration-depl-56b4bd57b9-2nthb expiration] Waiting this many milliseconds to process the job:  59983
[orders-depl-5755694bf7-9v7sx orders] Message received: ticket:updated / orders-service
[tickets-depl-7b8c654ffb-fmvt6 tickets] Event published to subject ticket:updated



